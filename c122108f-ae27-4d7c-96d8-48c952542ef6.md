# Supervision Notes: Langfuse Media Support Implementation
**Trace ID**: c122108f-ae27-4d7c-96d8-48c952542ef6
**Session ID**: d1bbb6bb-2c5d-41b0-a0f9-587b657ded06
**Issue**: #65

## Implementation Status Review

### ✅ Completed (Phases 1-3)

**Phase 1: Core Media Functions (cofuse.py)**
- ✅ Utility functions: SHA-256, MIME detection, validation
- ✅ Core API functions: get_media_upload_url, upload_media_to_url, patch_media_upload_status, get_media
- ✅ High-level helpers: upload_and_attach_media, download_url_and_attach

**Phase 3: MCP Server Integration**
- ✅ MCP tools added to server.py and tools.py
- ✅ coaia_fuse_media_upload, coaia_fuse_media_attach_url, coaia_fuse_media_get

### ⚠️ Status Unknown: CLI Integration (Phase 2)

**Need to verify**:
- CLI commands under `coaia fuse media` (upload, attach-url, get)
- Argument parsing for observation-id, field, json output

### ❌ Missing (Phases 4-6)

**Phase 4: Pipeline Template Support**
- ❌ Template action handlers (upload_media, attach_url) in pipeline.py
- ❌ Built-in templates: vision-analysis.json, audio-transcription.json, document-processing.json, multimodal-chain.json
- ❌ Environment export for media IDs

**Phase 5: Testing Suite**
- ❌ tests/test_media_upload.py
- ❌ Test scenarios:
  - Local JPEG upload (tests/notebook_graph.jpg)
  - Imgur URL (tests/image_medias.txt)
  - Dropbox URL (tests/dropbox_shared.txt)
  - SHA-256 deduplication
  - Observation attachment
  - CLI integration tests
  - MCP tool tests

**Phase 6: Documentation**
- ❌ CLAUDE.md media features section
- ❌ README.md media examples
- ⚠️ Inline docstrings (may be partially done)

---

## Next Steps (Priority Order)

### 1. **VERIFY CLI Implementation** (URGENT)
Check if `coaia fuse media` commands are fully functional:
```bash
coaia fuse media --help
coaia fuse media upload --help
coaia fuse media attach-url --help
coaia fuse media get --help
```

If missing, complete Phase 2 CLI integration.

### 2. **Create Comprehensive Test Suite** (CRITICAL)
File: `/src/coaiapy/tests/test_media_upload.py`

**Test Structure**:
```python
class TestMediaUtilities:
    - test_sha256_calculation()
    - test_content_type_detection()
    - test_content_type_validation()

class TestMediaUpload:
    - test_local_jpeg_upload()
    - test_imgur_url_download()
    - test_dropbox_url_download()
    - test_sha256_deduplication()
    - test_observation_attachment()
    - test_invalid_content_type()
    - test_missing_file()

class TestMediaRetrieval:
    - test_get_media_metadata()
    - test_download_url_expiry()

class TestCLIIntegration:
    - test_cli_upload_command()
    - test_cli_attach_url_command()
    - test_cli_get_command()

class TestMCPIntegration:
    - test_mcp_media_upload()
    - test_mcp_media_attach_url()
    - test_mcp_media_get()
```

**Test Data Available**:
- `tests/notebook_graph.jpg` - Local JPEG
- `tests/image_medias.txt` - Imgur URL
- `tests/dropbox_shared.txt` - Dropbox URLs
- `tests/.env` - Langfuse credentials

### 3. **Pipeline Template Support** (HIGH)
**Action**: Add to `/src/coaiapy/coaiapy/pipeline.py`

Add action handlers in `TemplateEngine.execute_step()`:
```python
elif action == "upload_media":
    result = upload_and_attach_media(
        file_path=step['file_path'],
        trace_id=step['trace_id'],
        field=step.get('field', 'input'),
        observation_id=step.get('observation_id')
    )
    if step.get('export_as'):
        context[step['export_as']] = result['mediaId']

elif action == "attach_url":
    result = download_url_and_attach(
        url=step['url'],
        trace_id=step['trace_id'],
        field=step.get('field', 'input'),
        observation_id=step.get('observation_id')
    )
    if step.get('export_as'):
        context[step['export_as']] = result['mediaId']
```

### 4. **Create Built-in Templates** (MEDIUM)
Create in `/src/coaiapy/coaiapy/templates/`:

**vision-analysis.json**:
```json
{
  "name": "vision-analysis-pipeline",
  "description": "Image upload and vision analysis workflow",
  "variables": {
    "image_path": "/path/to/image.jpg",
    "trace_name": "Vision Analysis",
    "user_id": "analyst-1"
  },
  "steps": [
    {
      "action": "create_trace",
      "trace_id": "{{ uuid4() }}",
      "name": "{{ trace_name }}",
      "user_id": "{{ user_id }}"
    },
    {
      "action": "upload_media",
      "file_path": "{{ image_path }}",
      "trace_id": "{{ trace_id }}",
      "field": "input",
      "export_as": "COAIA_IMAGE_MEDIA_ID"
    },
    {
      "action": "add_observation",
      "observation_id": "{{ uuid4() }}",
      "trace_id": "{{ trace_id }}",
      "name": "Image Analysis",
      "type": "SPAN",
      "metadata": {
        "input_media_id": "{{ COAIA_IMAGE_MEDIA_ID }}"
      }
    }
  ]
}
```

Similarly create:
- **audio-transcription.json**
- **document-processing.json**
- **multimodal-chain.json**

### 5. **Documentation Updates** (MEDIUM)
- Update `/src/coaiapy/CLAUDE.md` with media support section
- Add examples to `/src/coaiapy/README.md`
- Verify all new functions have proper docstrings

---

## Testing Validation Checklist

Before marking complete, verify:

- [ ] All test classes pass with real Langfuse API
- [ ] CLI commands work: `coaia fuse media upload tests/notebook_graph.jpg <trace_id>`
- [ ] MCP tools callable via coaiapy_aetherial
- [ ] Pipeline templates execute successfully
- [ ] SHA-256 deduplication confirmed (same file uploaded twice returns same mediaId)
- [ ] External URLs (imgur, dropbox) download and upload correctly
- [ ] Observation-level attachment works
- [ ] Error handling graceful (missing files, invalid MIME types)
- [ ] No new dependencies added (Python 3.6 compatible)

---

## Recommended Immediate Actions

1. **Run CLI verification** to confirm Phase 2 status
2. **Create test_media_upload.py** with real API tests
3. **Add pipeline template support** in pipeline.py
4. **Create 4 built-in templates**
5. **Run full test suite** and document results

---

## Notes for Implementation

- Use `tests/.env` Langfuse credentials for testing
- Test files available: notebook_graph.jpg, image_medias.txt, dropbox_shared.txt
- Follow existing cofuse.py patterns for error handling
- Ensure all responses have `{"success": bool, "error": str|None}` structure
- Document any issues or edge cases discovered during testing

---

**Current Branch**: claude/langfuse-media-support-01DKbZAHAypsV2cbMgs2Joqf
**Ready for**: Phase 4-5 implementation and comprehensive testing
